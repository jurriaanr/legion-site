<html>
<head>
    <title>Legion dice simulator</title>
    <meta name="description" content="This site will simulate an attack in Star Wars Legion. It will try the given dice pools 100000 times in a couple of seconds to come to a concrete average">
    <meta name="keywords" content="star wars legion dice roll attack defense surge simulator test automated">
    <meta name="web_author" content="Jurriaan Ruitenberg">
    <meta name="viewport" content="initial-scale=1">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
          integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <script
            src="https://code.jquery.com/jquery-3.4.1.min.js"
            integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
            crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
            integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
            crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
            integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
            crossorigin="anonymous"></script>
    <link rel="icon" type="image/png" href="favicon.png" />
    <style type="text/css">
        .dice {
            width: 30px;
            height: 30px;
        }

        .keyword {
            font-weight: bold;
        }

        @media only screen and (min-width: 768px){
            .dice {
                cursor: pointer;
                width: 40px;
                height: 40px;
            }
        }

        @media only screen and (min-width: 1600px){
            .dice {
                width: 60px;
                height: 60px;
            }
        }
    </style>
</head>
<body>
<h1 class="mb-4 card p-3 shadow-lg bg-dark text-light font-weight-light text-uppercase">Legion dice simulator</h1>
<div class="container-fluid">
    <p>
        This site will simulate an attack in Star Wars Legion. It will try the given dice pools 100000 times to come to a concrete average. The given results are the expected
        average remaining hits after defense dice have been applied. The shown dice results are the first 25 simulated dice rolls. They are shown before any applied rerolls,
        conversions or modifications. Click on the dice to see the modified results for that roll.
    </p>
    <form id="diceForm">
        <div class="row">
            <div class="col-lg-3 shadow-lg p-3">
                    <h3 class=" font-weight-light">Attack</h3>
                    <div class="form-group">
                        <label for="r">Number of red dice</label>
                        <input type="number" class="form-control form-control-sm" id="r" value="3" min="0" max="10">
                    </div>
                    <div class="form-group">
                        <label for="b">Number of black dice</label>
                        <input type="number" class="form-control form-control-sm" id="b" value="0" min="0" max="10">
                    </div>
                    <div class="form-group">
                        <label for="w">Number of white dice</label>
                        <input type="number" class="form-control form-control-sm" id="w" value="0" min="0" max="10">
                    </div>
                    <div class="form-group">
                        <label for="as">Convert surges to</label>
                        <select class="form-control form-control-sm" id="as">
                            <option value="">Nothing</option>
                            <option value="hits">Hits</option>
                            <option value="crits">Crits</option>
                        </select>
                    </div>
                    <p>
                        <button class="btn btn-light btn-sm" type="button" data-toggle="collapse" data-target="#attackAdvanced" aria-expanded="false" aria-controls="collapseExample">Advanced</button>
                    </p>
                    <div class="collapse" id="attackAdvanced">
                        <div class="form-group">
                            <label for="aim">Aim tokens</label>
                            <input type="number" class="form-control form-control-sm" id="aim" value="0" min="0" max="10">
                        </div>
                        <div class="form-group">
                            <label for="preciseX" class="keyword">Precise X</label>
                            <input type="number" class="form-control form-control-sm" id="preciseX" value="0" min="0" max="10">
                        </div>
                        <div class="form-group">
                            <label for="pierceX" class="keyword">Pierce X</label>
                            <input type="number" class="form-control form-control-sm" id="pierceX" value="0" min="0" max="10">
                        </div>
                        <div class="form-group">
                            <label for="criticalX" class="keyword">Critical X</label>
                            <input type="number" class="form-control form-control-sm" id="criticalX" value="0" min="0" max="10">
                        </div>
                        <div class="form-group">
                            <label for="ramX" class="keyword">Ram X</label>
                            <input type="number" class="form-control form-control-sm" id="ramX" value="0" min="0" max="10">
                        </div>
                    </div>
                    <h3 class=" font-weight-light">Defense</h3>
                    <div class="form-group">
                        <label for="d">Defend with</label>
                        <select class="form-control form-control-sm" id="d">
                            <option value="white">White</option>
                            <option value="red">Red</option>
                        </select>
                    </div>
                    <div class="form-group form-check">
                        <input type="checkbox" class="form-check-input" id="ds">
                        <label class="form-check-label" for="ds">Convert surges to blocks</label>
                    </div>
                    <p>
                        <button class="btn btn-light btn-sm" type="button" data-toggle="collapse" data-target="#defendAdvanced" aria-expanded="false" aria-controls="collapseExample">Advanced</button>
                    </p>
                    <div class="collapse" id="defendAdvanced">
                        <div class="form-group">
                            <label for="r">Dogde tokens</label>
                            <input type="number" class="form-control form-control-sm" id="dodge" value="0" min="0" max="10">
                        </div>
                        <div class="form-group">
                            <label for="r">Cover</label>
                            <input type="number" class="form-control form-control-sm" id="cover" value="0" min="0" max="2">
                        </div>
                        <div class="form-group">
                            <label for="r" class="keyword">Cover X</label>
                            <input type="number" class="form-control form-control-sm" id="coverX" value="0" min="0" max="2">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-dark">Roll dice!</button>
            </div>
            <div class="col-lg-9">
                <div class="shadow-lg p-3">
                    <div id="successes" class="card mb-3 pt-3 pl-3 pr-3 pb-2 bg-light">
                        <h5 class=" font-weight-light">Roll the dice to see the results... <button type="submit" class="btn btn-dark float-right">Roll dice!</button></h5>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead class="thead-dark">
                                <tr>
                                    <th>#</th>
                                    <th>Attack</th>
                                    <th>Defense</th>
                                    <th>Hits</th>
                                </tr>
                            </thead>
                            <tbody id="rolls">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
    const convertAttackDice = (result) => {
        const colors = ['Red', 'Black', 'White']
        const symbols = ['H', 'C', 'S', 'N']

        return convertDice(result, colors, symbols, 'a')
    }

    const convertDefenseDice = (result) => {
        const colors = ['Red', 'White']
        const symbols = ['B', 'S', 'N']

        return convertDice(result, colors, symbols, 'd')
    }

    const convertDice = (result, colors, symbols, prefix) => {
        const images = []
        for (const color of colors) {
            const c = color.substr(0, 1).toLowerCase()
            for (const symbol of symbols) {
                const s = symbol.toLowerCase()
                for (let i = 0; i < result[color][symbol]; i++) {
                    images.push(`${prefix}${c}${s}`)
                }
            }
        }

        return images.map((fileName) => {
            return `<img src="/img/${fileName}.png" alt="${fileName}" class="dice">`
        }).join('')
    }

    $('#diceForm').submit((e) => {
        e.preventDefault()
        // dice
        const r = $('#r').val()
        const b = $('#b').val()
        const w = $('#w').val()
        const as = $('#as').val()
        const d = $('#d').val()
        const ds = $('#ds').val()
        const cover = $('#cover').val()
        // tokens
        const aim = $('#aim').val()
        const dodge = $('#dodge').val()
        // keywords
        const preciseX = $('#preciseX').val()
        const pierceX = $('#pierceX').val()
        const criticalX = $('#criticalX').val()
        const ramX = $('#ramX').val()
        const coverX = $('#coverX').val()

        const dice = `r=${r}&b=${b}&w=${w}&as=${as}&d=${d}&ds=${ds}&cover=${cover}`
        const tokens = `aim=${aim}&dodge=${dodge}`
        const keywords = `preciseX=${preciseX}&pierceX=${pierceX}&criticalX=${criticalX}&ramX=${ramX}&coverX=${coverX}`
        const url = `https://us-central1-legion-dice.cloudfunctions.net/dice?${dice}&${tokens}&${keywords}`

        $.get(url, (res) => {
            let successes = `<h5 class="font-weight-light">The average number of hits on this attack is <span class="badge badge-dark">${res.Successes}</span> hits</h5>`
            let results = ''

            for (let i = 0;  i < res.Rolls.length; i++) {
                results += `<tr>
                                <th>${i+1}</th>
                                <td>
                                    <div data-toggle="collapse" data-target="#attackdice${i},#defensdice${i}">${convertAttackDice(res.Rolls[i].Attack)}</div>
                                    <div class="collapse" id="attackdice${i}">
                                        ${convertAttackDice(res.Rolls[i].AttackAfter)}<br>
                                        <small class="badge badge-info">Modified result</small>
                                    </div>
                                </td>
                                <td>
                                    <div data-toggle="collapse" data-target="#attackdice${i},#defensdice${i}">${convertDefenseDice(res.Rolls[i].Defense)}</div>
                                    <div class="collapse" id="defensdice${i}">
                                        ${convertDefenseDice(res.Rolls[i].DefenseAfter)}<br>
                                        <small class="badge badge-info">Modified result</small>
                                    </div>
                                </td>
                                <td>${res.Rolls[i].Hits}</td>
                            </tr>`
            }

            $('#successes').html(successes)
            $('#rolls').html(results)
            $('html,body').animate({scrollTop: $('#successes').offset().top});
        }, 'json')
    })
</script>

<script src="https://www.gstatic.com/firebasejs/7.5.2/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.5.2/firebase-analytics.js"></script>
<script>
    // Your web app's Firebase configuration
    var firebaseConfig = {
        apiKey: "AIzaSyDmzztfSQoQAG_YJH85o3sgwS7F5rAjdWU",
        authDomain: "legion-dice.firebaseapp.com",
        databaseURL: "https://legion-dice.firebaseio.com",
        projectId: "legion-dice",
        storageBucket: "legion-dice.appspot.com",
        messagingSenderId: "593119950085",
        appId: "1:593119950085:web:a3b82514be80ec5287336c",
        measurementId: "G-V8GHNM3HVT"
    };
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    firebase.analytics();
</script>
</body>
</html>