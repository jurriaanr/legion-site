<html>
<head>
    <title>Legion dice simulator</title>
    <meta name="description" content="This site will simulate an attack in Star Wars Legion. It will try the given dice pools 100000 times in a couple of seconds to come to a concrete average">
    <meta name="keywords" content="star wars legion dice roll attack defense surge simulator test automated">
    <meta name="web_author" content="Jurriaan Ruitenberg">
    <meta name="viewport" content="initial-scale=1">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
          integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <script
            src="https://code.jquery.com/jquery-3.4.1.min.js"
            integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
            crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
            integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
            crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
            integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
            crossorigin="anonymous"></script>
    <link rel="icon" type="image/png" href="favicon.png" />
    <style type="text/css">
        .dice {
            width: 30px;
            height: 30px;
        }

        .keyword {
            font-weight: bold;
        }

        @media only screen and (max-width: 750px){
            #roll2 {
                margin-top: 15px;
            }
        }

        @media only screen and (min-width: 768px){
            .dice {
                cursor: pointer;
                width: 40px;
                height: 40px;
            }
        }

        @media only screen and (min-width: 1600px){
            .dice {
                width: 60px;
                height: 60px;
            }
        }

        #chances table {
        }

        #chances table th {
            text-align: center;
            font-size: 0.8em;
        }

        #chances table td {
            font-size: 0.8em;
            text-align: center;
        }
    </style>
</head>
<body>
<div class="mb-4 card p-3 shadow-lg bg-dark container-fluid">
    <div class="row">
        <h1 class="text-light font-weight-light text-uppercase col-lg-6">Legion dice simulator</h1>
        <div class="dropdown col-lg-6">
            <a class="btn btn-secondary btn-sm dropdown-toggle float-right" href="#" role="button" id="dropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                settings
            </a>
            <div class="dropdown-menu p-3" aria-labelledby="dropdownMenuLink">
                <div class="form-check">
                    <input class="form-check-input diceViewMode" type="radio" id="diceUnmoddedFirst" value="unmodded" checked>
                    <label class="form-check-label" for="diceUnmoddedFirst">
                        Show dice before modifications first
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input diceViewMode" type="radio" id="diceModdedFirst" value="modded">
                    <label class="form-check-label" for="diceModdedFirst">
                        Show dice after modifications first
                    </label>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="container-fluid">
    <p>
        This site will simulate an attack in Star Wars Legion. It will try the given dice pools 100000 times to come to a concrete average. The given results are the expected
        average remaining hits after defense dice have been applied. The shown dice results are the first 25 simulated dice rolls. <span id="diceViewModeTxt"></span>. Click on the advanced buttons to see more options like cover, aim, etc.
    </p>
    <form id="diceForm">
        <div class="row">
            <div class="col-lg-3 shadow-lg p-3">
                    <h3 class=" font-weight-light">Attack</h3>
                    <div class="form-group">
                        <label for="r">Number of red dice</label>
                        <input type="number" class="form-control form-control-sm" id="r" value="3" min="0" max="10">
                    </div>
                    <div class="form-group">
                        <label for="b">Number of black dice</label>
                        <input type="number" class="form-control form-control-sm" id="b" value="0" min="0" max="10">
                    </div>
                    <div class="form-group">
                        <label for="w">Number of white dice</label>
                        <input type="number" class="form-control form-control-sm" id="w" value="0" min="0" max="10">
                    </div>
                    <div class="form-group">
                        <label for="as">Convert surges to</label>
                        <select class="form-control form-control-sm" id="as">
                            <option value="">Nothing</option>
                            <option value="hits">Hits</option>
                            <option value="crits">Crits</option>
                        </select>
                    </div>
                    <p>
                        <button class="btn btn-light btn-sm" type="button" data-toggle="collapse" data-target="#attackAdvanced" aria-expanded="false" aria-controls="collapseExample">Advanced</button>
                    </p>
                    <div class="collapse" id="attackAdvanced">
                        <div class="form-group" title="A unit can spend one or more aim tokens to reroll up to two dice for each aim token spent">
                            <label for="aim">Aim tokens</label>
                            <input type="number" class="form-control form-control-sm" id="aim" value="0" min="0" max="10">
                        </div>
                        <div class="form-group form-check" title="Ignore cover">
                            <input type="checkbox" class="form-check-input" id="blast">
                            <label class="form-check-label keyword" for="blast">Blast</label>
                        </div>
                        <div class="form-group form-check" title="While attacking, if each weapon in your attack pool has High Velocity, the defender cannot spend dodge tokens">
                            <input type="checkbox" class="form-check-input" id="highVelocity">
                            <label class="form-check-label keyword" for="highVelocity">High Velocity</label>
                        </div>
                        <div class="form-group" title="When you spend an aim token, reroll up to X additional die/dice">
                            <label for="preciseX" class="keyword">Precise X</label>
                            <input type="number" class="form-control form-control-sm" id="preciseX" value="0" min="0" max="10">
                        </div>
                        <div class="form-group" title="Ignore up to X block results.">
                            <label for="pierceX" class="keyword">Pierce X</label>
                            <input type="number" class="form-control form-control-sm" id="pierceX" value="0" min="0" max="10">
                        </div>
                        <div class="form-group" title="While attacking a unit that has Armor, change up to X hits to crits">
                            <label for="impactX" class="keyword">Impact X</label>
                            <input type="number" class="form-control form-control-sm" id="impactX" value="0" min="0" max="10">
                        </div>
                        <div class="form-group" title="While converting surges, change up to X hit results to crit">
                            <label for="criticalX" class="keyword">Critical X</label>
                            <input type="number" class="form-control form-control-sm" id="criticalX" value="0" min="0" max="10">
                        </div>
                        <div class="form-group" title="If you performed a full standard move at your maximum sped before this attack, you may turn 1 attack die to a crit">
                            <label for="ramX" class="keyword">Ram X</label>
                            <input type="number" class="form-control form-control-sm" id="ramX" value="0" min="0" max="10">
                        </div>
                        <div class="form-group" title="While performing a ranged attack, reduce the defenderâ€™s cover by X">
                            <label for="sharpshooterX" class="keyword">Sharpshooter X</label>
                            <input type="number" class="form-control form-control-sm" id="sharpshooterX" value="0" min="0" max="10">
                        </div>
                    </div>
                    <h3 class=" font-weight-light">Defense</h3>
                    <div class="form-group">
                        <label for="d">Defend with</label>
                        <select class="form-control form-control-sm" id="d">
                            <option value="white">White</option>
                            <option value="red">Red</option>
                        </select>
                    </div>
                    <div class="form-group form-check">
                        <input type="checkbox" class="form-check-input" id="ds">
                        <label class="form-check-label" for="ds">Convert surges to blocks</label>
                    </div>
                    <p>
                        <button class="btn btn-light btn-sm" type="button" data-toggle="collapse" data-target="#defendAdvanced" aria-expanded="false" aria-controls="collapseExample">Advanced</button>
                    </p>
                    <div class="collapse" id="defendAdvanced">
                        <div class="form-group" title="During the 'Apply Dodge and Cover' step, you can spend one or more dodge tokens to cancel one hit for each dodge token spent">
                            <label for="dodge">Dogde tokens</label>
                            <input type="number" class="form-control form-control-sm" id="dodge" value="0" min="0" max="10">
                        </div>
                        <div class="form-group" title="During the 'Apply Dodge and Cover' step of a ranged attack, light cover can cancel one hit, heavy cover cancels up to two hits">
                            <label for="cover">Cover</label>
                            <input type="number" class="form-control form-control-sm" id="cover" value="0" min="0" max="2">
                        </div>
                        <div class="form-group form-check" title="While defending, cancel all hit results">
                            <input type="checkbox" class="form-check-input" id="armor">
                            <label class="form-check-label keyword" for="armor">Armor</label>
                        </div>
                        <div class="form-group form-check" title="While defending, if you have light cover, improve your cover by 1">
                            <input type="checkbox" class="form-check-input" id="lowProfile">
                            <label class="form-check-label keyword" for="lowProfile">Low Profile</label>
                        </div>
                        <div class="form-group form-check" title="While defending, if the attack pool has Pierce X, roll x additional dice">
                            <input type="checkbox" class="form-check-input" id="impervious">
                            <label class="form-check-label keyword" for="impervious">Impervious</label>
                        </div>
                        <div class="form-group" title="While defending against a ranged attack, improve your cover by X">
                            <label for="coverX" class="keyword">Cover X</label>
                            <input type="number" class="form-control form-control-sm" id="coverX" value="0" min="0" max="2">
                        </div>
                        <div class="form-group" title="While defending, cancel X hit results">
                            <label for="armorX" class="keyword">Armor X</label>
                            <input type="number" class="form-control form-control-sm" id="armorX" value="0" min="0" max="10">
                        </div>
                        <div class="form-group" title="While defending, you may reroll up to X defense dice">
                            <label for="uncannyLuckX" class="keyword">Uncanny Luck X</label>
                            <input type="number" class="form-control form-control-sm" id="uncannyLuckX" value="0" min="0" max="10">
                        </div>
                    </div>
                    <button type="submit" id="roll1" class="btn btn-dark roll">Roll dice!</button>
            </div>
            <div class="col-lg-9">
                <div class="shadow-lg p-3">
                    <div class="card mb-3 pt-3 pl-3 pr-3 pb-2 bg-light" id="successesContainer">
                        <h5 class=" font-weight-light">
                            <div id="successes">Roll the dice to see the results...</div>
                            <div id="chances" class="table-responsive"></div>
                            <button id="roll2" type="submit" class="btn btn-dark btn-sm float-right roll">Roll dice!</button>
                        </h5>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead class="thead-dark">
                                <tr>
                                    <th>#</th>
                                    <th>Attack</th>
                                    <th>Defense</th>
                                    <th>Hits</th>
                                </tr>
                            </thead>
                            <tbody id="rolls">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
    const cookies = {
        setCookie : (name, value, days) => {
            let expires = "";
            if (days) {
                const date = new Date();
                date.setTime(date.getTime() + (days*24*60*60*1000));
                expires = "; expires=" + date.toUTCString();
            }
            document.cookie = name + "=" + (value || "")  + expires + "; path=/";
        },

        getCookie: (name) => {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for(let i = 0, l = ca.length; i < l; i++) {
                const c = ca[i].trim();
                if (c.indexOf(nameEQ) === 0) {
                    return c.substring(nameEQ.length, c.length);
                }
            }
            return null;
        },

        eraseCookie : (name) => {
            document.cookie = name+'=; Max-Age=-99999999;';
        }
    }

    const getDiceViewMode = () => {
        return cookies.getCookie('diceViewMode') || $('.diceViewMode:checked').val();
    }

    const saveDiceViewMode = (val) => {
        return cookies.setCookie('diceViewMode', val, 365);
    }

    const convertAttackDice = (result) => {
        const colors = ['Red', 'Black', 'White']
        const symbols = ['H', 'C', 'S', 'N']

        return convertDice(result, colors, symbols, 'a')
    }

    const convertDefenseDice = (result) => {
        const colors = ['Red', 'White']
        const symbols = ['B', 'S', 'N']

        return convertDice(result, colors, symbols, 'd')
    }

    const getChancesTable = (chances) => {
        let th = '';
        let td = '';

        for (let i = 0, l = chances.length; i < l; i++) {
            th += `<th>${i}</th>`
            td += `<td>${Math.round(chances[i] * 10) / 10}%</td>`
        }

        return `<table class="table table-bordered table-sm mt-4"><thead class="thead-dark"><tr>${th}</tr></thead><tbody><tr>${td}</tr></tbody></table>`
    }

    const convertDice = (result, colors, symbols, prefix) => {
        const images = []
        for (const color of colors) {
            const c = color.substr(0, 1).toLowerCase()
            for (const symbol of symbols) {
                const s = symbol.toLowerCase()
                for (let i = 0; i < result[color][symbol]; i++) {
                    images.push(`${prefix}${c}${s}`)
                }
            }
        }

        if (images.length === 0) {
            images.push('n')
        }

        return images.map((fileName) => {
            return `<img src="/img/${fileName}.png" alt="${fileName}" class="dice">`
        }).join('')
    }

    $('.diceViewMode').attr('checked', false).click((e) => {
        saveDiceViewMode($(e.target).val())
    })

    $('.diceViewMode[value=' + getDiceViewMode() + ']').attr('checked', 'checked')

    $('#diceViewModeTxt').html(getDiceViewMode() === 'unmodded' ?
        'The results are <em>before</em> any applied rerolls, conversions or modifications. Click on the dice to see the modified results for that roll' :
        'The results are <em>after</em> any applied rerolls, conversions or modifications. Click on the dice to see the unmodified results for that roll'
    )

    $('input[type=number]').on('focus', (e) => {
        const el = $(e.target)
        el.data('prev', el.val())
        el.val('')
    }).on('blur', (e) => {
        const el = $(e.target)
        if (el.val() === '') {
            el.val(el.data('prev'))
        } else if (parseInt(el.val()) > parseInt(el.attr('max'))) {
            el.val(el.attr('max'))
        }
    })

    $('#diceForm').submit((e) => {
        e.preventDefault()

        // dice
        const r = $('#r').val()
        const b = $('#b').val()
        const w = $('#w').val()
        const as = $('#as').val()
        const d = $('#d').val()
        const ds = $('#ds').is(':checked')
        const cover = $('#cover').val()
        // tokens
        const aim = $('#aim').val()
        const dodge = $('#dodge').val()
        // attack keywords
        const preciseX = $('#preciseX').val()
        const pierceX = $('#pierceX').val()
        const impactX = $('#impactX').val()
        const criticalX = $('#criticalX').val()
        const sharpshooterX = $('#sharpshooterX').val()
        const ramX = $('#ramX').val()
        const blast = $('#blast').is(':checked')
        const highVelocity = $('#highVelocity').is(':checked')

        // defensive keywords
        const armor = $('#armor').is(':checked')
        const impervious = $('#impervious').is(':checked')
        const coverX = $('#coverX').val()
        const armorX = $('#armorX').val()
        const uncannyLuckX = $('#uncannyLuckX').val()

        const dice = `r=${r}&b=${b}&w=${w}&as=${as}&d=${d}&ds=${ds}&cover=${cover}`
        const tokens = `aim=${aim}&dodge=${dodge}`
        const attackKeywords = `preciseX=${preciseX}&pierceX=${pierceX}&criticalX=${criticalX}&ramX=${ramX}&impactX=${impactX}&blast=${blast}&highVelocity=${highVelocity}&sharpshooterX=${sharpshooterX}`
        const defenseKeywords = `coverX=${coverX}&armorX=${armorX}&uncannyLuckX=${uncannyLuckX}&armor=${armor}&impervious=${impervious}`
        const keywords = `${attackKeywords}&${defenseKeywords}`
        const url = `https://us-central1-legion-dice.cloudfunctions.net/dice?${dice}&${tokens}&${keywords}`

        gtag('event', 'roll', {
            'event_category' : 'Rolls',
            'event_label' : 'clicked on ' + (document.activeElement ? document.activeElement.id : '??'),
            'value' : parseInt(r) + parseInt(b) + parseInt(w)
        });

        $.get(url, (res) => {
            let successes = `The average number of hits on this attack is <span class="badge badge-dark">${res.Successes}</span> hits`
            let results = ''

            const showUnmoddedFirst = getDiceViewMode() === 'unmodded'
            $('#chances').html(getChancesTable(res.Chances))

            for (let i = 0;  i < res.Rolls.length; i++) {
                results += `<tr>
                                <th>${i+1}</th>
                                <td>
                                    <div data-toggle="collapse" data-target="#attackdice${i},#defensdice${i}">${convertAttackDice(showUnmoddedFirst ? res.Rolls[i].Attack : res.Rolls[i].AttackAfter)}</div>
                                    <div class="collapse" id="attackdice${i}">
                                        ${convertAttackDice(showUnmoddedFirst ? res.Rolls[i].AttackAfter : res.Rolls[i].Attack)}<br>
                                        <small class="badge badge-light">${showUnmoddedFirst ? 'Modified' : 'Unmodified'}</small>
                                    </div>
                                </td>
                                <td>
                                    <div data-toggle="collapse" data-target="#attackdice${i},#defensdice${i}">${convertDefenseDice(showUnmoddedFirst ? res.Rolls[i].Defense : res.Rolls[i].DefenseAfter)}</div>
                                    <div class="collapse" id="defensdice${i}">
                                        ${convertDefenseDice(showUnmoddedFirst ? res.Rolls[i].DefenseAfter : res.Rolls[i].Defense)}<br>
                                        <small class="badge badge-light">${showUnmoddedFirst ? 'Modified' : 'Unmodified'}</small>
                                    </div>
                                </td>
                                <td>${res.Rolls[i].Hits}</td>
                            </tr>`
            }

            $('#successes').html(successes)
            $('#rolls').html(results)
            $('html,body').animate({scrollTop: $('#successesContainer').offset().top});
        }, 'json')
    })
</script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-154489572-1"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-154489572-1', { 'anonymize_ip': true });
</script>

</body>
</html>