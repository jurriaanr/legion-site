<html>
<head>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
          integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <script
            src="https://code.jquery.com/jquery-3.4.1.min.js"
            integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
            crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
            integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
            crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
            integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
            crossorigin="anonymous"></script>
    <style type="text/css">
        .dice {
            width: 40px;
            height: 40px;
        }

        .keyword {
            font-weight: bold;
        }

        @media only screen and (min-width: 768px){
            .dice {
                width: 60px;
                height: 60px;
            }
        }

        @media only screen and (min-width: 1600px){
            .dice {
                width: 80px;
                height: 80px;
            }
        }
    </style>
</head>
<body>
<div class="container-fluid">
    <h1 class="mb-4 text-uppercase">Legion dice simulator</h1>
    <p>
        This site will try the given dice pools 100000 times to come to a concrete average. The given results are the expected
        average remaining hits after defense dice have been applied. The shown dice results are the first 25 simulated dice rolls
    </p>
    <div class="row">
        <div class="col-lg-3">
            <form id="diceForm" class="shadow-lg p-3">
                <h3>Attack</h3>
                <div class="form-group">
                    <label for="r">Number of red dice</label>
                    <input type="number" class="form-control" id="r" value="3" min="0" max="10">
                </div>
                <div class="form-group">
                    <label for="b">Number of black dice</label>
                    <input type="number" class="form-control" id="b" value="0" min="0" max="10">
                </div>
                <div class="form-group">
                    <label for="w">Number of white dice</label>
                    <input type="number" class="form-control" id="w" value="0" min="0" max="10">
                </div>
                <div class="form-group">
                    <label for="as">Convert surges to</label>
                    <select class="form-control" id="as">
                        <option value="">Nothing</option>
                        <option value="hits">Hits</option>
                        <option value="crits">Crits</option>
                    </select>
                </div>
                <p>
                    <button class="btn btn-light btn-sm" type="button" data-toggle="collapse" data-target="#attackAdvanced" aria-expanded="false" aria-controls="collapseExample">Advanced</button>
                </p>
                <div class="collapse" id="attackAdvanced">
                    <div class="form-group">
                        <label for="r">Aim tokens</label>
                        <input type="number" class="form-control" id="aim" value="0" min="0" max="10">
                    </div>
                    <div class="form-group">
                        <label for="r" class="keyword">Precise X</label>
                        <input type="number" class="form-control" id="preciseX" value="0" min="0" max="10">
                    </div>
                </div>
                <h3>Defense</h3>
                <div class="form-group">
                    <label for="d">Defend with</label>
                    <select class="form-control" id="d">
                        <option value="white">White</option>
                        <option value="red">Red</option>
                    </select>
                </div>
                <div class="form-group form-check">
                    <input type="checkbox" class="form-check-input" id="ds">
                    <label class="form-check-label" for="ds">Convert surges to block</label>
                </div>
                <p>
                    <button class="btn btn-light btn-sm" type="button" data-toggle="collapse" data-target="#defendAdvanced" aria-expanded="false" aria-controls="collapseExample">Advanced</button>
                </p>
                <div class="collapse" id="defendAdvanced">
                    <div class="form-group">
                        <label for="r">Dogde tokens</label>
                        <input type="number" class="form-control" id="dodge" value="0" min="0" max="10">
                    </div>
                    <div class="form-group">
                        <label for="r">Cover</label>
                        <input type="number" class="form-control" id="cover" value="0" min="0" max="2">
                    </div>
                    <div class="form-group">
                        <label for="r" class="keyword">Cover X</label>
                        <input type="number" class="form-control" id="coverX" value="0" min="0" max="2">
                    </div>
                </div>
                <button type="submit" class="btn btn-dark">Roll dice!</button>
            </form>
        </div>
        <div class="col-lg-9">
            <div class="shadow-lg p-3">
                <h3>Results</h3>
                <div id="successes" class="card mb-2 mt-2 pt-3 pl-3 pr-3 pb-2 bg-light">
                    <h5>Roll the dice to see the results</h5>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead class="thead-dark">
                            <tr>
                                <th>#</th>
                                <th>Attack</th>
                                <th>Defense</th>
                            </tr>
                        </thead>
                        <tbody id="rolls">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const convertAttackDice = (result) => {
        const colors = ['Red', 'Black', 'White']
        const symbols = ['H', 'C', 'S', 'N']

        return convertDice(result, colors, symbols, 'a')
    }

    const convertDefenseDice = (result) => {
        const colors = ['Red', 'White']
        const symbols = ['B', 'S', 'N']

        return convertDice(result, colors, symbols, 'd')
    }

    const convertDice = (result, colors, symbols, prefix) => {
        const images = []
        for (const color of colors) {
            const c = color.substr(0, 1).toLowerCase()
            for (const symbol of symbols) {
                const s = symbol.toLowerCase()
                for (let i = 0; i < result[color][symbol]; i++) {
                    images.push(`${prefix}${c}${s}`)
                }
            }
        }

        return images.map((fileName) => {
            return `<img src="/img/${fileName}.png" alt="${fileName}" class="dice">`
        }).join('')
    }

    $('#diceForm').submit((e) => {
        e.preventDefault()
        // dice
        const r = $('#r').val()
        const b = $('#b').val()
        const w = $('#w').val()
        const as = $('#as').val()
        const d = $('#d').val()
        const ds = $('#ds').val()
        const cover = $('#cover').val()
        // tokens
        const aim = $('#aim').val()
        const dodge = $('#dodge').val()
        // keywords
        const preciseX = $('#preciseX').val()
        const coverX = $('#coverX').val()

        const dice = `r=${r}&b=${b}&w=${w}&as=${as}&d=${d}&ds=${ds}&cover=${cover}`
        const tokens = `aim=${aim}&dodge=${dodge}`
        const keywords = `preciseX=${preciseX}&coverX=${coverX}`
        const url = `https://us-central1-legion-dice.cloudfunctions.net/dice?${dice}&${tokens}&${keywords}`

        $.get(url, (res) => {
            console.log(res)
            let successes = `<h5>The average number of hits on this attack is <span class="badge badge-dark">${res.Successes}</span> hits</h5>`
            let results = ''

            for (let i = 0;  i < res.Rolls.length; i++) {
                results += `<tr><th>${i+1}</th><td>${convertAttackDice(res.Rolls[i].Attack)}</td><td>${convertDefenseDice(res.Rolls[i].Defense)}</td></tr>`
            }

            $('#successes').html(successes)
            $('#rolls').html(results)
        }, 'json')


    })
</script>
</body>
</html>